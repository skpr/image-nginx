name: 🏗️ Build PR

on:
  pull_request: ~

env:
  stream: "pr-${{ github.event.pull_request.number }}"

jobs:
  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 🐋 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare output dir
        run: mkdir -p out

      - name: 🏗️ Build OCI tarball for tests (no HCL changes)
        uses: docker/bake-action@v6
        env:
          STREAM: ${{ env.stream }}
        with:
          targets: drupal-dev
          set: |
            drupal-dev.platform=linux/amd64
            drupal-dev.output=type=oci,dest=out/drupal-dev.tar
            drupal-dev.tags=skpr/php-drupal:dev-v3-latest

      - name: Load image into local daemon
        run: docker load -i out/drupal-dev.tar

      - name: Test
        run: |
          export IMAGE=skpr/php-drupal:dev-v3-latest
          IMAGE=${IMAGE} docker-compose -f drupal/tests/docker-compose.yml up -d
          go run drupal/tests/test.go
          IMAGE=${IMAGE} docker-compose -f drupal/tests/docker-compose.yml down
